--- 
title: "LASV Bioplex Analysis"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    source_code: https://github.com/neidl-connor-lab/lasvShiny
    theme: flatly 
    vertical_layout: fill


--- 

```{r global, include=FALSE}

###-----Load Packages----

if (!require("pacman")) install.packages("pacman")
pacman::p_load(yaml,
               knitr,
               markdown,
               shiny,
               shinyWidgets,
               devtools,
               ggplot2,
               stats,
               statmod,
               tidyverse,
               pROC,
               # sqldf,
               corrplot,
               readxl,
               hablar,
               ggpubr,
               patchwork,
               # tidyr,
               # dplyr,
               plotly,
               DT,
               # tiff,
               ggsci,
               # stargazer,
               # svglite,
               Cairo,
               magrittr,
               gghighlight,
               flexdashboard,
               ggrepel,
               lubridate,
               RColorBrewer
               # rJava,
               # dygraphs
               )

# pacman::p_load(plotly, ggpubr, lubridate, shiny, flexdashboard)

source("dataImport.R")
options(scipen = 999)
set.seed(1234)


```

Proteins
=======================================================================

Sidebar {.sidebar}
-----------------------------------------------------------------------

```{r}

pickerInput("Factor1", "Factor",
             choices  = colnames(adm_all %>% select(ct:CRE)),
             selected = "ct",
             options  = list(`actions-box` = TRUE), multiple = F
             )

pickerInput("Factor2", "Factor 2 (Scatter y-axis)",
             choices  = colnames(adm_all %>% select(ct:CRE)),
             selected = "PAI1",
             options  = list(`actions-box` = TRUE), multiple = F
             )

radioButtons("Color", "Color",
         choices  = colnames(metaPatients)[-c(1,4)],
         selected = "Outcome")

radioButtons("Pos", "Bar Position",
                 choices = c("stack", "dodge"), 
                 selected = "dodge")

```



Row  {.tabset .tabset-fade}
-----------------------------------------------------------------------

### Histogram

```{r fig.width=1200}


adm <- adm_all %>% left_join(metaPatients %>% select(-Outcome, -Age), 
                          by = "id")

mainPanel(
  
  renderPlotly({
      
      ggplot(adm, aes_string(x=input$Factor1)) +
        scale_x_log10() + scale_y_log10() +
        geom_histogram(aes_string(fill=input$Color),
            position = input$Pos)
      
    }),
    
    renderPlotly({
      
      ggplot(adm, aes_string(x=input$Factor2)) +
        scale_x_log10() + scale_y_log10() +
        geom_histogram(aes_string(fill=input$Color),
            position = input$Pos)
      
  })
  
)



```


### Scatter

```{r}

  
  renderPlotly({
    
    ggplot(adm, aes_string(x=input$Factor1, y = input$Factor2)) +
      scale_x_log10() + scale_y_log10() +
      geom_point(aes_string(color=input$Color))
    
  })
```


### Interactive Boxplots

```{r}


box.select <- reactive ({

  box.data  %>%
    dplyr::filter(Factor %in% c(input$Factor1)) %>%
    as.data.frame() %>%
    ggplot(aes(x=Outcome, y = Value)) +
    geom_boxplot()  +
    scale_x_discrete(labels=c("F", "S", "OFI", "HC")) +
    scale_y_log10() +
    theme(#text = element_text(size=24),
          plot.title = element_text(hjust = .5),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.spacing = unit(1.25, "lines"),
          axis.title.x = element_blank(),
          text = element_text(size = 20),
          axis.title.y = element_blank(),
          legend.title = element_blank()
          )
})


# renderDataTable(
#   box.select() 
# )
# 
# renderPlotly({
#     box.select()
# })
 
renderPlotly({
    box.select()+
    geom_point(aes_string(fill=input$Color), size=2.5, 
               alpha = .7,
               position = position_jitterdodge())
})
```

### Statstics

```{r}
   # output$single.box.stats <-
    renderPlot({
        box.select() + 
        aes(color=Outcome)+
        stat_compare_means(comparisons = my_comparisons,
                             size=4,
                             label = "p.signif",
                             method = "wilcox.test")
    })

```



ROC Curves
=======================================================================

Row {data-width=350}
-----------------------------------------------------------------------

```{r}

sidebarPanel(selectizeInput("Plot1", "Plot 1",
             choices  = colnames(adm_all %>% select(TNFa:RANTES)),
             selected = "PAI1",
             options  = list(`actions-box` = TRUE),
             multiple = T
             ),

          selectizeInput("Plot2", "Plot 2",
             choices  = colnames(adm_all %>% select(TNFa:RANTES)),
             selected = "TM",
             options  = list(`actions-box` = TRUE),
             multiple = T
             ))

f <- glmFits(adm_all, cytokines = cytokines) %>% 
  rocFits(.)
names(f) <- cytokines

mainPanel(
  renderPlotly({
      pROC::ggroc(f[input$Plot1])+
          coord_fixed() +
          scale_color_lancet(labels=get.pretty.name(input$Plot1))+
          theme_pubr() +
          theme(legend.position = c(0.65, 0.4),
                legend.text = element_text(size = 12),
                legend.title = element_blank()) 
  }),
  
  renderPlotly({
      pROC::ggroc(f[input$Plot2])+
          coord_fixed() +
          scale_color_lancet(labels=get.pretty.name(input$Plot2))+
          theme_pubr() +
          theme(legend.position = c(0.65, 0.4),
                legend.text = element_text(size = 12),
                legend.title = element_blank()) 
  })
)
```

Demographics
=======================================================================

Column 
-----------------------------------------------------------------------

```{r}

# not allowing for id or Age as choices

sidebarPanel(radioButtons("Group", h4("Group by (x-axis)"),
             choices  = colnames(metaPatients)[-c(1,4)],
             selected = "Dataset"
             ),
    
    radioButtons("Fill", h4("Color"),
                 choices  = colnames(metaPatients)[-c(1,4)],
                 selected = "Outcome"
                 ),
    
    radioButtons("Pos", h4("Bar Position"),
                 choices = c("stack", "dodge"), 
                 selected = "dodge")
#     , 
#     
#     sliderInput("ageBins", "Bins (age groups)", value = 5,
#                 min = 1, max = 20)
)


# for everything but Age, need 'stat = "count"' in histogram
# for Age, need the binwidth
mainPanel(
  renderPlotly({
    metaPatients %>%
        ggplot(aes_string(x=input$Group, fill=input$Fill)) +
        geom_histogram(
            # binwidth = as.numeric(input$ageBins), 
            stat = "count",
            position = input$Pos) +
        theme_pubr() 
})
)


```
