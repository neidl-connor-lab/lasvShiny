--- 
title: "LASV Bioplex Analysis"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    source_code: https://github.com/neidl-connor-lab/lasvShiny
    theme: flatly 
    vertical_layout: fill



--- 

```{r global, include=FALSE}

###-----Load Packages----

if (!require("pacman")) install.packages("pacman")
pacman::p_load(shiny,
               shinyWidgets,
               devtools,
               ggplot2,
               stats,
               statmod,
               tidyverse,
               pROC,
               corrplot,
               readxl,
               hablar,
               ggpubr,
               patchwork,
               plotly,
               DT,
               ggsci,
               Cairo,
               magrittr,
               gghighlight,
               flexdashboard,
               lubridate,
               RColorBrewer
               )

source("dataImport.R")
options(scipen = 999)
set.seed(1234)


```


Sidebar {.sidebar}
====================

```{r}

pickerInput("Factor1", h4("Factor"),
             choices  = levels(factor(box.data$Factor)), 
             selected = "ct",
             options  = list(`actions-box` = TRUE), multiple = F
             )

pickerInput("Factor2", h4("Factor 2 (Scatter y-axis)"),
             choices  = levels(factor(box.data$Factor)), 
             selected = "PAI1",
             options  = list(`actions-box` = TRUE), multiple = F
             )

radioButtons("Color", h4("Color"),
         choices  = colnames(metaPatients)[-c(1,4)],
         selected = "Outcome")


```

Demographics
=======================================================================

Column 
-----------------------------------------------------------------------

#### Demographic Data

*Datasets:*

* Participants were divided into two datasets for statistical analysis: 
  + a **Primary** dataset (samples taken January 2014 through April 2016), and 
  + a **Secondary** dataset (samples taken May 2016 through April 2017). 
  
*Outcome groups:*

* Patients who tested positive for LASV had their outcome recorded: 
  1. **(F)atal** or 
  2. **(S)urvivor**
* Two control groups:
  3. Patients who tested negative for LASV but had a fever (**Other Febrile Illness/OFI**)
  4. Healthy volunteers from Nigeria and Europe (**Healthy Controls/HC**)

*Other demographic data:*

1. Sex (Male/Female/Unknown)
2. Place of origin within Nigeria (State)
3. Age (in bins of 20 years)

```{r}

radioButtons("Group", h4("Group by (x-axis)"),
             choices  = colnames(metaPatients)[-c(1,4)],
             selected = "Dataset", inline = T
             )
    
radioButtons("PosDem", h4("Bar Position"),
             choices = c("stack", "dodge"), 
             selected = "stack", inline = T
             )

mainPanel(
  renderPlotly(
    metaPatients %>%
      
        ggplot(aes_string(x=input$Group, fill=input$Color)) +
      
        geom_bar(
            stat = "count",
            position = input$PosDem, width = 0.7) +
        theme_pubr() 
  ),
  
  renderPlotly(
    metaPatients %>%
      
        ggplot(aes_string(x=input$Group, fill=input$Color)) +
      
        geom_bar(aes(y = (..count..)/sum(..count..)), 
                 stat="count",
                 position = input$PosDem, width = 0.7) + 
        scale_y_continuous(labels=scales::percent) +
        ylab("relative frequencies")+
        theme_pubr() 
  )
)


```

Proteins
=======================================================================

Column  {.tabset .tabset-fade}
-----------------------------------------------------------------------

### Density

```{r}

p <-  function(f) {
  box.data %>% filter(Factor %in% c(f)) %>%
    ggplot(aes_string(x="Value", fill=input$Color)) +
      scale_x_log10() + 
      geom_density(alpha=0.6)+
      ggtitle(get.pretty.name(f)) +
      xlab(get.pretty.units(f)) +
      theme_pubr() 
  
  } %>% ggplotly(height = 300, width = 600) 

shiny::fluidRow(
  
  renderPlotly({
      
    p(input$Factor1)  
      
  })
)
    
fluidRow(
  
  renderPlotly({
      
    p(input$Factor2) #%>% ggplotly(height = 300, width = 600)
      
  })
  
)



```


### Scatter

```{r}



s <- function(c){ 
  pre.box.data %>%
    
  ggplot(aes_string(x=input$Factor1, y = input$Factor2)) +
    scale_x_log10() + scale_y_log10() +
    geom_point(aes_string(color=input$Color)) +
    ggtitle("Two Factor Scatter Plot") +
    xlab(get.pretty.factor(input$Factor1))+
    ylab(get.pretty.factor(input$Factor2)) +
    theme(text = element_text(size = 14))
  
  }  %>% ggplotly(height = 600, width = 800)
  


renderPlotly({
  
  s(input$Color)
  
})
```


### Interactive Boxplots

```{r}


b <- function(f, c) {
  box.data  %>%
    dplyr::filter(Factor == (f)) %>%
    as.data.frame() %>%
    
    ggplot(aes(x=Outcome, y = Value)) +

      scale_x_discrete(labels=c("F", "S", "OFI", "HC")) +
      scale_y_log10() + 

      theme(
            plot.title = element_text(hjust = .5),
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            panel.spacing = unit(1.25, "lines"),
            text = element_text(size = 14)

            )+

      ggtitle(get.pretty.name(f)) +      
      geom_boxplot(outlier.color = NA,
                   outlier.size = 0,
                   outlier.shape = NA)  +
      geom_jitter(position = position_jitterdodge(), 
                  aes_string(fill=c), 
                  alpha=0.75,
                  shape=21,
                  size=2.5) +
      # theme_pubr() +
      ylab(get.pretty.units(f)) +
    xlab("Outcome")
} 



renderPlotly({

    b(input$Factor1, input$Color)%>% ggplotly(height = 500, width = 700, ) 
  
})
```

### Boxplot Stats

```{r}

renderPlot({

  b(input$Factor1, input$Color) + 

    stat_compare_means(comparisons = my_comparisons,
                       size=4,
                       label = "p.signif",
                       method = "wilcox.test") 
    
})


```


### ROC Curves

*Note, ROC curves not yet available in this app for clinical parameters (AST, ALT, BUN, CRE).*
```{r}
cytokines = colnames(adm %>% select(ct:RANTES))


selectizeInput("Factor3", h4("Additional Factor(s)"),
             choices  = cytokines,
             # selected = c("TM", "IL8", "DDIMER"),
             options  = list(`actions-box` = TRUE),
             multiple = T
             )
             



glmDat <- glmFits(adm, cytokines)

glmCo <- glmDat %>% 
  glmCoefs(cytokines)

rocData <- glmDat %>% 
  rocFits(cytokines)

names(rocData) <- cytokines


rocRes <- rocCoords(rocFits = rocData, glmCoefs = glmCo, cytokines)

rocResFormat <- rocRes %>% rownames_to_column("Var") %>%
  left_join(units, by = "Var") %>%
  select(Name, AUC, Threshold=thresh.val, Units, p.value, 
         specificity, sensitivity, ppv, npv) %>%
  mutate_if(is.numeric, round, 3) 

r <- function(f){
  pROC::ggroc(rocData[f])+
          coord_fixed() +
          scale_fill_discrete(labels=c(get.pretty.name(f)))+
          theme_pubr() +
          theme(legend.position = c(0.65, 0.4),
                legend.text = element_text(size = 12),
                legend.title = element_blank()) 
    # geom_point(aes(x = rocRes$specificity[f], y =rocRes$sensitivity[f]))
  } %>% ggplotly(height = 400, width = 600) #%>% layout(height = 400, width = 600)


mainPanel(
  renderPlotly({
    
    r(c(input$Factor1, input$Factor3))
    
  })
)
```

### ROC Data


```{r}
mainPanel(

  DT::renderDataTable(DT::datatable(rocResFormat))
  
)
```


